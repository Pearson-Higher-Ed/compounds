const fs             = require('fs');
const ReactDOMServer = require('react-dom/server');
const React          = require('react');
const ReactDOM       = require('react-dom');


// put these in webpack.config.js
const htmlTemplatePath     =  `${__dirname}/demo/index.html`;
const pagesToRenderDirPath =  `${__dirname}/demo/demoPages/`;
const buildPath            =  `${__dirname}/build/`;
const filterOn             =  'page';


function WebpackRoutesToPagesPlugin(htmlTemplatePath, pagesToRenderDirPath, buildPath, filterOn) {}

WebpackRoutesToPagesPlugin.prototype.apply = function(compiler) {
  console.log('=====================Static Render====================')

  let buildArray = [];

  compiler.plugin('emit', function(compilation, callback) {
    // Explore each chunk (build output):
    compilation.chunks.forEach(function(chunk) {
      // Explore each asset filename generated by the chunk:
      chunk.files.forEach(function(filename) {
        // Get the asset source for each file generated by the chunk:
        var source = compilation.assets[filename].source();
        buildArray.push({filename, source});
      });
    });

    // grab html filenames...
    const buildArrayFilteredHtml      = buildArray.filter(build => build.filename.search(`(${filterOn})`) >= 0 );
    const buildArrayFilteredHtmlNoMap = buildArrayFilteredHtml.filter(build => build.filename.search(`(map)`) <= 0 );
    const buildArrayFilenameExt       = buildArrayFilteredHtml.map(build => build.filename.replace('.compounds.js','.html'));
    const buildArrayFilenameNoExt     = buildArrayFilteredHtml.map(build => build.filename.replace('.compounds.js',''));
// console.log(buildArrayFilteredHtmlNoMap)
    // grab js files...
    const buildArrayFilteredJs = buildArray.filter(build => build.filename.search(`(${filterOn})`) <= 0 );

    // Make the build dir...
    fs.mkdirSync(buildPath);

    // write the built files...
    buildArrayFilteredJs.map((build,i) => fs.writeFileSync(`${buildPath}${build.filename}`, build.source));

    // Render Elements...
    buildArray.map((build, i) => {
      if (build.filename === 'homepage.compounds.js' ){
      // console.log('############',build.filename)
      fs.writeFileSync(`${buildPath}${buildArrayFilenameExt[i]}`, ReactDOMServer.renderToStaticMarkup(
          React.DOM.body(
          null,
          React.DOM.div({
            id: 'app',
            dangerouslySetInnerHTML: {
              __html: React.createElement(build.source)
            }
          }),
          React.DOM.script({
            src: 'vendor.compounds.js'
          }),
          React.DOM.script({
            src: 'dev.compounds.js'
          }),
          React.DOM.script({
            src: 'dist.compounds.js'
          })
        )
      ))
    }
    });

    console.log('files written...')
    console.log('======================================================')

    callback();

  });
};

module.exports = WebpackRoutesToPagesPlugin;
